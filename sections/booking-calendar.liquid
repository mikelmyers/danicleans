{% comment %}
  Booking Calendar Section
  Embeds a scheduling widget so customers can self-book.
  Supports Calendly, Cal.com, or a simple built-in weekly picker.
  When no external calendar URL is set, shows a built-in request form
  that lets customers pick their preferred day/time.
{% endcomment %}

<div class="booking-section" style="padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;">
  <div class="booking-container">
    <h2 class="booking-title">{{ section.settings.heading }}</h2>
    <p class="booking-subtitle">{{ section.settings.subheading }}</p>

    {% if section.settings.calendar_url != blank %}
      <!-- External calendar embed (Calendly / Cal.com) -->
      <div class="booking-embed">
        <iframe
          src="{{ section.settings.calendar_url }}"
          width="100%"
          height="630"
          frameborder="0"
          loading="lazy"
          title="Book an appointment"
        ></iframe>
      </div>
    {% else %}
      <!-- Built-in scheduling request form -->
      <div class="booking-form-wrap">
        <form method="post" action="/contact" id="BookingForm" accept-charset="UTF-8" class="booking-form">
          <input type="hidden" name="form_type" value="contact">
          <input type="hidden" name="utf8" value="✓">
          <input type="hidden" name="contact[Source]" value="Booking Calendar">

          <div class="booking-row">
            <div class="booking-field">
              <label for="booking-name">Your Name *</label>
              <input type="text" id="booking-name" name="contact[name]" required>
            </div>
            <div class="booking-field">
              <label for="booking-phone">Phone *</label>
              <input type="tel" id="booking-phone" name="contact[Phone Number]" required>
            </div>
          </div>
          <div class="booking-row">
            <div class="booking-field">
              <label for="booking-email">Email</label>
              <input type="email" id="booking-email" name="contact[email]" placeholder="Optional">
            </div>
            <div class="booking-field">
              <label for="booking-service">Service</label>
              <select id="booking-service" name="contact[Service]">
                <option value="Recurring Cleaning">Recurring Cleaning</option>
                <option value="Deep Cleaning">Deep Cleaning</option>
                <option value="Move-In/Move-Out">Move-In / Move-Out</option>
                <option value="Lawn Mowing">Lawn Mowing</option>
                <option value="Landscaping">Landscaping</option>
                <option value="Seasonal Cleanup">Seasonal Cleanup</option>
                <option value="Bundle">Cleaning + Landscaping Bundle</option>
              </select>
            </div>
          </div>

          <label class="booking-field-label">Preferred Day & Time</label>
          <div class="booking-slots" id="bookingSlots">
            <!-- Generated by JS for current week -->
          </div>

          <input type="hidden" name="contact[Preferred Time]" id="booking-time-hidden" value="">
          <input type="hidden" name="contact[body]" id="booking-body-hidden" value="">

          <div class="booking-row">
            <div class="booking-field full">
              <label for="booking-address">Property Address *</label>
              <input type="text" id="booking-address" name="contact[Property Address]" required>
            </div>
          </div>

          <button type="submit" class="booking-submit" id="bookingSubmit">Request This Time Slot</button>
          <p class="booking-note">We'll confirm your appointment within 24 hours. You can also call <strong>434-351-0335</strong> for same-day availability.</p>
        </form>

        <div class="booking-success" id="bookingSuccess" style="display:none;">
          <div class="booking-success-icon">&#10003;</div>
          <h3>Booking Request Sent!</h3>
          <p>We'll confirm your appointment within 24 hours. Check your phone for a confirmation text.</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<style>
.booking-section { background: #f7faf7; }
.booking-container { max-width: 700px; margin: 0 auto; padding: 0 20px; }
.booking-title { text-align: center; font-size: 32px; color: #1a3a2a; margin-bottom: 8px; }
.booking-subtitle { text-align: center; color: #555; font-size: 16px; margin-bottom: 32px; }
.booking-embed { border-radius: 12px; overflow: hidden; }
.booking-form-wrap { background: #fff; border-radius: 12px; padding: 32px; border: 1px solid #e0e8e0; }
.booking-row { display: flex; gap: 16px; margin-bottom: 16px; }
.booking-field { flex: 1; }
.booking-field.full { flex: 1 1 100%; }
.booking-field label, .booking-field-label {
  display: block; font-weight: 600; font-size: 14px;
  color: #1a3a2a; margin-bottom: 6px;
}
.booking-field input, .booking-field select {
  width: 100%; padding: 10px 12px; border: 1px solid #ccc;
  border-radius: 8px; font-size: 15px; font-family: inherit;
}
.booking-field input:focus, .booking-field select:focus {
  outline: none; border-color: #2d6a4f;
  box-shadow: 0 0 0 2px rgba(45,106,79,0.15);
}
.booking-slots {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 8px; margin-bottom: 20px;
}
.booking-slot {
  padding: 12px 8px; background: #fff; border: 2px solid #e0e8e0;
  border-radius: 8px; cursor: pointer; text-align: center;
  font-family: inherit; transition: all 0.2s; font-size: 13px;
}
.booking-slot:hover { border-color: #2d6a4f; }
.booking-slot.selected { border-color: #2d6a4f; background: #2d6a4f; color: #fff; }
.booking-slot .slot-day { font-weight: 700; display: block; margin-bottom: 2px; }
.booking-slot .slot-time { font-size: 12px; opacity: 0.8; }
.booking-submit {
  display: block; width: 100%; padding: 16px; background: #2d6a4f;
  color: #fff; border: none; border-radius: 8px; font-size: 16px;
  font-weight: 700; cursor: pointer; font-family: inherit; transition: background 0.2s;
}
.booking-submit:hover { background: #245a42; }
.booking-note { text-align: center; font-size: 13px; color: #888; margin-top: 12px; }
.booking-success {
  text-align: center; padding: 40px 20px;
}
.booking-success-icon {
  width: 60px; height: 60px; background: #2d6a4f; color: #fff;
  border-radius: 50%; display: inline-flex; align-items: center;
  justify-content: center; font-size: 28px; margin-bottom: 16px;
}
.booking-success h3 { color: #1a3a2a; margin-bottom: 8px; }
.booking-success p { color: #555; }
@media (max-width: 600px) {
  .booking-row { flex-direction: column; }
  .booking-slots { grid-template-columns: 1fr 1fr; }
  .booking-form-wrap { padding: 20px; }
}
</style>

<script>
(function() {
  var slotsContainer = document.getElementById('bookingSlots');
  var hiddenTime = document.getElementById('booking-time-hidden');
  var hiddenBody = document.getElementById('booking-body-hidden');
  if (!slotsContainer) return;

  var DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  var MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var TIMES = ['Morning (8-10am)', 'Mid-day (10am-1pm)', 'Afternoon (1-4pm)'];

  var today = new Date();
  var slots = [];

  // Generate slots for next 7 business days
  var d = new Date(today);
  d.setDate(d.getDate() + 1); // start tomorrow
  var count = 0;
  while (count < 7) {
    if (d.getDay() !== 0) { // skip Sunday
      for (var t = 0; t < TIMES.length; t++) {
        slots.push({
          date: new Date(d),
          day: DAYS[d.getDay()] + ' ' + MONTHS[d.getMonth()] + ' ' + d.getDate(),
          time: TIMES[t]
        });
      }
      count++;
    }
    d.setDate(d.getDate() + 1);
  }

  slots.forEach(function(slot, i) {
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'booking-slot';
    btn.innerHTML = '<span class="slot-day">' + slot.day + '</span><span class="slot-time">' + slot.time + '</span>';
    btn.addEventListener('click', function() {
      slotsContainer.querySelectorAll('.booking-slot').forEach(function(b) { b.classList.remove('selected'); });
      btn.classList.add('selected');
      hiddenTime.value = slot.day + ' — ' + slot.time;
    });
    slotsContainer.appendChild(btn);
  });

  // Form submission
  var form = document.getElementById('BookingForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      var name = document.getElementById('booking-name').value;
      var service = document.getElementById('booking-service').value;
      var time = hiddenTime.value;
      var address = document.getElementById('booking-address').value;
      hiddenBody.value = 'BOOKING REQUEST: ' + name + ' | Service: ' + service + ' | Preferred: ' + time + ' | Address: ' + address;
    });
  }

  // Show success on return
  if (window.location.search.indexOf('success=true') !== -1 && window.location.search.indexOf('form_type=contact') !== -1) {
    var formEl = document.querySelector('.booking-form');
    var successEl = document.getElementById('bookingSuccess');
    if (formEl && successEl) {
      formEl.style.display = 'none';
      successEl.style.display = 'block';
    }
  }
})();
</script>

{% schema %}
{
  "name": "Booking Calendar",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Book Your Service"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Pick a day and time that works for you. We'll confirm within 24 hours."
    },
    {
      "type": "url",
      "id": "calendar_url",
      "label": "External Calendar URL (Calendly / Cal.com)",
      "info": "Leave blank to use the built-in scheduling form. Paste your Calendly or Cal.com embed URL here."
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0, "max": 100, "step": 4, "unit": "px",
      "label": "Top padding", "default": 52
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0, "max": 100, "step": 4, "unit": "px",
      "label": "Bottom padding", "default": 52
    }
  ],
  "presets": [
    {
      "name": "Booking Calendar"
    }
  ]
}
{% endschema %}
