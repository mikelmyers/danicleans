{% comment %}
  AI-Powered Chatbot for Dani Cleans
  Handles FAQs, captures leads, books appointments 24/7.
  Works with a knowledge base — no external API needed.
{% endcomment %}

<!-- Chat Toggle Button -->
<button class="chat-toggle" id="chatToggle" aria-label="Chat with us">
  <svg class="chat-icon-open" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
  <svg class="chat-icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
</button>

<!-- Chat Window -->
<div class="chat-window" id="chatWindow" style="display:none;">
  <div class="chat-header">
    <div class="chat-header-info">
      <div class="chat-status-dot"></div>
      <div>
        <strong>Dani Cleans</strong>
        <span class="chat-status-text">Typically replies instantly</span>
      </div>
    </div>
    <button class="chat-minimize" id="chatMinimize" aria-label="Minimize chat">—</button>
  </div>

  <div class="chat-messages" id="chatMessages">
    <!-- Messages inserted by JS -->
  </div>

  <div class="chat-quick-replies" id="chatQuickReplies">
    <!-- Quick reply buttons inserted by JS -->
  </div>

  <div class="chat-input-area">
    <input type="text" id="chatInput" placeholder="Type your message..." autocomplete="off">
    <button id="chatSend" aria-label="Send message">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
    </button>
  </div>
</div>

<style>
.chat-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: #2d6a4f;
  color: #fff;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  transition: transform 0.2s, background 0.2s;
}
.chat-toggle:hover { transform: scale(1.05); background: #245a42; }

@media (max-width: 749px) {
  .chat-toggle { bottom: 82px; }
}

.chat-window {
  position: fixed;
  bottom: 88px;
  right: 20px;
  z-index: 1001;
  width: 380px;
  max-height: 520px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
@media (max-width: 749px) {
  .chat-window {
    bottom: 0; right: 0; left: 0; top: 0;
    width: 100%; max-height: 100%;
    border-radius: 0;
  }
}
.chat-header {
  background: #2d6a4f;
  color: #fff;
  padding: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.chat-header-info { display: flex; align-items: center; gap: 10px; }
.chat-header-info strong { display: block; font-size: 15px; }
.chat-status-dot {
  width: 10px; height: 10px; background: #4caf50;
  border-radius: 50%; flex-shrink: 0;
}
.chat-status-text { font-size: 12px; opacity: 0.85; }
.chat-minimize {
  background: transparent; border: none; color: #fff;
  font-size: 20px; cursor: pointer; padding: 4px 8px;
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  min-height: 280px;
}
.chat-msg {
  max-width: 85%;
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.5;
  animation: chatFadeIn 0.3s ease;
}
@keyframes chatFadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.chat-msg.bot {
  background: #f0f5f0;
  color: #1a3a2a;
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}
.chat-msg.user {
  background: #2d6a4f;
  color: #fff;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}
.chat-msg.typing {
  background: #f0f5f0;
  align-self: flex-start;
}
.chat-msg.typing .dots { display: inline-flex; gap: 4px; }
.chat-msg.typing .dot {
  width: 6px; height: 6px; background: #999; border-radius: 50%;
  animation: chatDot 1.2s infinite;
}
.chat-msg.typing .dot:nth-child(2) { animation-delay: 0.2s; }
.chat-msg.typing .dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes chatDot { 0%, 60% { opacity: 0.3; } 30% { opacity: 1; } }

.chat-quick-replies {
  padding: 0 16px 8px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.chat-quick-btn {
  padding: 7px 14px;
  background: #fff;
  border: 1px solid #2d6a4f;
  border-radius: 16px;
  font-size: 13px;
  color: #2d6a4f;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s;
}
.chat-quick-btn:hover { background: #2d6a4f; color: #fff; }

.chat-input-area {
  display: flex;
  padding: 12px;
  border-top: 1px solid #eee;
  gap: 8px;
}
.chat-input-area input {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid #ddd;
  border-radius: 20px;
  font-size: 14px;
  font-family: inherit;
  outline: none;
}
.chat-input-area input:focus { border-color: #2d6a4f; }
.chat-input-area button {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: #2d6a4f;
  color: #fff;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

/* Lead capture form inside chat */
.chat-lead-form { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
.chat-lead-form input {
  padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px;
  font-size: 13px; font-family: inherit;
}
.chat-lead-form button {
  padding: 10px; background: #2d6a4f; color: #fff; border: none;
  border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;
  font-family: inherit;
}
</style>

<script>
(function() {
  var KNOWLEDGE = {
    pricing: "Our cleaning starts around $100-$260 depending on home size, and lawn care starts at $40-$160 depending on yard size. Use our instant quote calculator on the homepage for a personalized estimate, or I can help you get a free quote right now!",
    services: "We offer home cleaning (recurring, deep cleaning, move-in/move-out) and landscaping (lawn mowing, garden design, seasonal cleanup). We also have a bundle discount when you combine both!",
    areas: "We serve Charlottesville, Albemarle County, Crozet, Keswick, Earlysville, Free Union, Waynesboro, Staunton, Lake Monticello, and surrounding areas.",
    booking: "You can request a free estimate on our website, call us at 434-351-0335, or share your info here and we'll reach out within 24 hours!",
    hours: "We're available Monday through Saturday. Our office hours are 8am-6pm, but we can accommodate early morning and evening appointments.",
    eco: "Yes! We offer eco-friendly cleaning products that are safe for kids, pets, and your family. Just let us know when you book.",
    guarantee: "Absolutely — we offer a 100% satisfaction guarantee. If you're not happy with any part of our work, we'll come back and make it right at no extra charge.",
    pets: "Pet-friendly! We love animals. We use pet-safe products and our team is comfortable working around pets.",
    cancel: "No long-term contracts. You can cancel or pause your service anytime with 24-hour notice.",
    commercial: "We serve offices, retail spaces, restaurants, HOA common areas, and rental properties. We offer recurring contracts with flexible scheduling.",
    insurance: "Yes, we are fully insured and bonded. Your property is protected on every visit.",
    frequency: "For recurring cleaning, we offer weekly (save 20%), bi-weekly (save 10%), and monthly plans. Lawn care is available weekly or bi-weekly.",
    move: "Our move-in/move-out cleaning covers every room, closet, cabinet, and appliance. We'll help you get your full deposit back!"
  };

  var INTENT_MAP = [
    { patterns: ['price', 'cost', 'how much', 'rate', 'expensive', 'cheap', 'afford', 'estimate', 'quote'], key: 'pricing' },
    { patterns: ['service', 'offer', 'what do you', 'clean', 'landscape', 'mow', 'lawn'], key: 'services' },
    { patterns: ['area', 'where', 'location', 'serve', 'charlottesville', 'albemarle', 'crozet'], key: 'areas' },
    { patterns: ['book', 'schedule', 'appointment', 'when', 'available', 'start'], key: 'booking' },
    { patterns: ['hour', 'open', 'time', 'days'], key: 'hours' },
    { patterns: ['eco', 'green', 'natural', 'organic', 'chemical', 'safe'], key: 'eco' },
    { patterns: ['guarantee', 'satisfied', 'happy', 'refund', 'not happy'], key: 'guarantee' },
    { patterns: ['pet', 'dog', 'cat', 'animal'], key: 'pets' },
    { patterns: ['cancel', 'contract', 'commitment', 'stop', 'pause'], key: 'cancel' },
    { patterns: ['commercial', 'office', 'business', 'restaurant', 'retail'], key: 'commercial' },
    { patterns: ['insur', 'bond', 'protect', 'liable', 'damage'], key: 'insurance' },
    { patterns: ['often', 'frequent', 'weekly', 'monthly', 'bi-weekly', 'how often'], key: 'frequency' },
    { patterns: ['move', 'moving', 'move-in', 'move-out', 'deposit'], key: 'move' }
  ];

  var conversationState = 'greeting';
  var leadData = {};

  function $(id) { return document.getElementById(id); }

  function addMessage(text, sender) {
    var div = document.createElement('div');
    div.className = 'chat-msg ' + sender;
    div.innerHTML = text;
    $('chatMessages').appendChild(div);
    $('chatMessages').scrollTop = $('chatMessages').scrollHeight;
  }

  function showTyping() {
    var div = document.createElement('div');
    div.className = 'chat-msg typing';
    div.id = 'typingIndicator';
    div.innerHTML = '<div class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
    $('chatMessages').appendChild(div);
    $('chatMessages').scrollTop = $('chatMessages').scrollHeight;
  }

  function hideTyping() {
    var el = $('typingIndicator');
    if (el) el.remove();
  }

  function botReply(text, delay) {
    delay = delay || 800;
    showTyping();
    setTimeout(function() {
      hideTyping();
      addMessage(text, 'bot');
    }, delay);
  }

  function setQuickReplies(replies) {
    var container = $('chatQuickReplies');
    container.innerHTML = '';
    replies.forEach(function(r) {
      var btn = document.createElement('button');
      btn.className = 'chat-quick-btn';
      btn.textContent = r.label;
      btn.addEventListener('click', function() {
        addMessage(r.label, 'user');
        container.innerHTML = '';
        if (r.action) r.action();
        else processInput(r.label);
      });
      container.appendChild(btn);
    });
  }

  function showLeadForm() {
    var formHtml = '<div class="chat-lead-form" id="chatLeadForm">' +
      '<input type="text" id="chatLeadName" placeholder="Your name">' +
      '<input type="tel" id="chatLeadPhone" placeholder="Phone number">' +
      '<input type="email" id="chatLeadEmail" placeholder="Email (optional)">' +
      '<button onclick="window.__chatSubmitLead()">Send My Info</button>' +
      '</div>';
    addMessage("I'd love to get you connected with our team. Share your info and we'll reach out within 24 hours:", 'bot');
    setTimeout(function() {
      addMessage(formHtml, 'bot');
    }, 500);
  }

  window.__chatSubmitLead = function() {
    var name = $('chatLeadName').value;
    var phone = $('chatLeadPhone').value;
    var email = $('chatLeadEmail').value;
    if (!name || !phone) {
      addMessage("Please enter at least your name and phone number.", 'bot');
      return;
    }
    leadData = { name: name, phone: phone, email: email };

    // Submit as Shopify contact form via fetch
    var formData = new FormData();
    formData.append('form_type', 'contact');
    formData.append('utf8', '\u2713');
    formData.append('contact[name]', name);
    formData.append('contact[email]', email || name + '@chatbot-lead.com');
    formData.append('contact[Phone Number]', phone);
    formData.append('contact[body]', 'CHATBOT LEAD: ' + name + ' | ' + phone + ' | ' + (email || 'no email') + ' | Conversation: ' + conversationState);
    formData.append('contact[Source]', 'AI Chatbot');

    fetch('/contact', { method: 'POST', body: formData })
      .then(function() {
        addMessage("Thanks, " + name + "! Our team will reach out within 24 hours. In the meantime, you can call us anytime at <strong>434-351-0335</strong>.", 'bot');
        setQuickReplies([
          { label: "I have another question", action: function() { showMainMenu(); } }
        ]);
      })
      .catch(function() {
        addMessage("Thanks " + name + "! We noted your info. Please call us at <strong>434-351-0335</strong> if you need immediate help.", 'bot');
      });

    conversationState = 'lead-captured';
  };

  function matchIntent(input) {
    var lower = input.toLowerCase();
    for (var i = 0; i < INTENT_MAP.length; i++) {
      for (var j = 0; j < INTENT_MAP[i].patterns.length; j++) {
        if (lower.indexOf(INTENT_MAP[i].patterns[j]) !== -1) {
          return INTENT_MAP[i].key;
        }
      }
    }
    return null;
  }

  function showMainMenu() {
    botReply("What can I help you with?", 400);
    setTimeout(function() {
      setQuickReplies([
        { label: "Get a price estimate", action: function() { botReply(KNOWLEDGE.pricing); offerLead(); } },
        { label: "What services do you offer?", action: function() { botReply(KNOWLEDGE.services); showServiceFollowup(); } },
        { label: "Do you serve my area?", action: function() { botReply(KNOWLEDGE.areas); offerLead(); } },
        { label: "I want to book a service", action: function() { showLeadForm(); } }
      ]);
    }, 600);
  }

  function showServiceFollowup() {
    setTimeout(function() {
      setQuickReplies([
        { label: "How much does it cost?", action: function() { botReply(KNOWLEDGE.pricing); offerLead(); } },
        { label: "Book a service", action: function() { showLeadForm(); } },
        { label: "Use the quote calculator", action: function() {
          botReply("Great idea! Our instant calculator gives you a price in under 60 seconds. <a href='#quote-calculator' style='color:#2d6a4f;font-weight:600;'>Open the Quote Calculator</a>");
        }}
      ]);
    }, 1000);
  }

  function offerLead() {
    setTimeout(function() {
      setQuickReplies([
        { label: "Get a free quote", action: function() { showLeadForm(); } },
        { label: "Use the calculator", action: function() {
          botReply("Try our instant quote calculator! <a href='#quote-calculator' style='color:#2d6a4f;font-weight:600;'>Click here to open it</a>");
        }},
        { label: "I have another question", action: function() { showMainMenu(); } }
      ]);
    }, 1000);
  }

  function processInput(input) {
    var intent = matchIntent(input);
    if (intent) {
      botReply(KNOWLEDGE[intent]);
      offerLead();
    } else if (input.toLowerCase().match(/^(hi|hello|hey|yo|sup)/)) {
      botReply("Hey there! Welcome to Dani Cleans. How can I help you today?");
      setTimeout(function() { showMainMenu(); }, 1000);
    } else if (input.toLowerCase().match(/(thank|thanks|thx)/)) {
      botReply("You're welcome! Is there anything else I can help with?");
      setTimeout(function() {
        setQuickReplies([
          { label: "Get a free quote", action: function() { showLeadForm(); } },
          { label: "No, that's all", action: function() { botReply("Great, have a wonderful day! Call us anytime at <strong>434-351-0335</strong>."); } }
        ]);
      }, 1000);
    } else {
      botReply("I want to make sure you get the right answer! You can call us at <strong>434-351-0335</strong> or share your info and our team will get back to you within 24 hours.");
      offerLead();
    }
  }

  // Event listeners
  $('chatToggle').addEventListener('click', function() {
    var win = $('chatWindow');
    var isOpen = win.style.display !== 'none';
    win.style.display = isOpen ? 'none' : 'flex';
    document.querySelector('.chat-icon-open').style.display = isOpen ? 'block' : 'none';
    document.querySelector('.chat-icon-close').style.display = isOpen ? 'none' : 'block';

    if (!isOpen && $('chatMessages').children.length === 0) {
      addMessage("Hi! I'm the Dani Cleans assistant. I can answer questions about our services, give you a quick estimate, or connect you with our team.", 'bot');
      setTimeout(function() { showMainMenu(); }, 1200);
    }
  });

  $('chatMinimize').addEventListener('click', function() {
    $('chatWindow').style.display = 'none';
    document.querySelector('.chat-icon-open').style.display = 'block';
    document.querySelector('.chat-icon-close').style.display = 'none';
  });

  $('chatSend').addEventListener('click', function() { sendUserMessage(); });
  $('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendUserMessage();
  });

  function sendUserMessage() {
    var input = $('chatInput').value.trim();
    if (!input) return;
    addMessage(input, 'user');
    $('chatInput').value = '';
    $('chatQuickReplies').innerHTML = '';
    processInput(input);
  }

  // Auto-open after 30 seconds if user hasn't interacted
  var autoOpenTimer = setTimeout(function() {
    if ($('chatWindow').style.display === 'none') {
      $('chatToggle').style.animation = 'chatPulse 2s ease-in-out 3';
    }
  }, 30000);

  $('chatToggle').addEventListener('click', function() { clearTimeout(autoOpenTimer); }, { once: true });
})();
</script>

<style>
@keyframes chatPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); box-shadow: 0 4px 24px rgba(45,106,79,0.4); }
}
</style>

{% schema %}
{
  "name": "AI Chatbot",
  "settings": [],
  "presets": [
    {
      "name": "AI Chatbot"
    }
  ]
}
{% endschema %}
