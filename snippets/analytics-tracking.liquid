{% comment %}
  Analytics & Conversion Tracking
  GA4 + Facebook Pixel + Google Ads — powered by Theme Settings.
  Configure IDs at: Shopify Admin → Online Store → Themes → Customize → Theme Settings → Analytics & Tracking
  Rendered globally via theme.liquid <head>.
{% endcomment %}

{% assign ga4_id = settings.ga4_measurement_id %}
{% assign gads_id = settings.google_ads_id %}
{% assign gads_label = settings.google_ads_conversion_label %}
{% assign fb_pixel = settings.facebook_pixel_id %}

<!-- Google Analytics 4 -->
{% if ga4_id != blank %}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ ga4_id }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ ga4_id }}');
  {% if gads_id != blank %}
  gtag('config', '{{ gads_id }}');
  {% endif %}
</script>
{% endif %}

<!-- Facebook / Meta Pixel -->
{% if fb_pixel != blank %}
<script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
  (window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '{{ fb_pixel }}');
  fbq('track', 'PageView');
</script>
{% endif %}

<!-- Universal Form Conversion Tracking -->
<script>
(function() {
  // Track all form submissions as conversion events
  document.addEventListener('submit', function(e) {
    var form = e.target;
    if (form.action && form.action.indexOf('/contact') !== -1) {
      var source = form.querySelector('[name="contact[Source]"]');
      var label = source ? source.value : 'Contact Form';

      // GA4 event
      if (typeof gtag === 'function') {
        gtag('event', 'generate_lead', {
          event_category: 'Lead',
          event_label: label,
          value: 250
        });

        {% if gads_id != blank and gads_label != blank %}
        gtag('event', 'conversion', {
          'send_to': '{{ gads_id }}/{{ gads_label }}',
          'value': 250,
          'currency': 'USD'
        });
        {% endif %}
      }

      // Facebook Pixel event
      if (typeof fbq === 'function') {
        fbq('track', 'Lead', {
          content_name: label,
          value: 250,
          currency: 'USD'
        });
      }
    }
  });

  // Track phone clicks as conversions
  document.addEventListener('click', function(e) {
    var link = e.target.closest('a[href^="tel:"]');
    if (link) {
      if (typeof gtag === 'function') {
        gtag('event', 'click_to_call', { event_category: 'Lead', event_label: link.href });
      }
      if (typeof fbq === 'function') {
        fbq('track', 'Contact', { content_name: 'Phone Call' });
      }
    }
  });

  // Track SMS button clicks
  document.addEventListener('click', function(e) {
    var link = e.target.closest('a[href^="sms:"]');
    if (link) {
      if (typeof gtag === 'function') {
        gtag('event', 'click_to_text', { event_category: 'Lead', event_label: 'SMS Button' });
      }
      if (typeof fbq === 'function') {
        fbq('track', 'Contact', { content_name: 'SMS' });
      }
    }
  });

  // Track calculator completion
  var calcForm = document.getElementById('CalcLeadForm');
  if (calcForm) {
    calcForm.addEventListener('submit', function() {
      if (typeof gtag === 'function') {
        var estimate = document.getElementById('calc-hidden-estimate');
        gtag('event', 'calculator_lead', {
          event_category: 'Lead',
          event_label: 'Quote Calculator',
          value: estimate ? parseInt(estimate.value.replace(/[^0-9]/g, '')) || 250 : 250
        });
      }
    });
  }
})();
</script>
